

library(shiny)
library(tidyverse)
library(lubridate)

shinyServer(function(input, output) {

# load the sample data
dfsample <- structure(list(napt = structure(c(1349551800, 1349569800, 1349573100, 
1349588640, 1349589660, 1349601360, 1349604720, 1349607600, 1349613840, 
1349624580, 1349631180, 1349633040, 1349636820, 1349637240, 1349637600, 
1349642100, 1349644500, 1349660580, 1349663580, 1349673960, 1349675160, 
1349681940, 1349683200, 1349690400, 1349694960, 1349697060, 1349699820, 
1349703720, 1349707020, 1349717820, 1349923020, 1349938440, 1349942880, 
1349945100, 1349949600, 1349956500, 1349959980, 1349966460, 1349969100, 
1349973780, 1349992500, 1350005700, 1350011400, 1350013500, 1350014940, 
1350023940, 1350024900, 1350028500, 1350034560, 1350044940, 1350047340, 
1350056160, 1350061560, 1350063360, 1350065520, 1350069120, 1350072000, 
1350079200, 1350081120, 1350091380, 1350092700, 1350096840, 1350100740, 
1350101100, 1350101400, 1350103500, 1350104880, 1350108480, 1350109800, 
1350118740, 1350123300, 1350128700, 1350134160, 1350145680, 1350148800, 
1350152400, 1350161520, 1350175920, 1350177480, 1350188700, 1350192720, 
1350197400, 1350198480, 1350202080, 1350212400, 1350215100, 1350218160, 
1350229980, 1350234840, 1350240240, 1350244800, 1350258000, 1350260760, 
1350268920, 1350269940, 1350280920, 1350281400, 1350285000, 1350299880, 
1350303540, 1350306000, 1350311400, 1350315060, 1350317760, 1350336240, 
1350336540, 1350337440, 1350351420, 1350352920, 1350365700, 1350366960, 
1350376560, 1350380340, 1350381240, 1350387900, 1350392400, 1350393540, 
1350400560, 1350404100, 1350409920, 1350415200, 1350416160, 1350428400, 
1350442800, 1350445380, 1350459660, 1350469080, 1350480120, 1350484980, 
1350488160, 1350493200, 1350495000, 1350499800, 1350505440, 1350512880, 
1350526440, 1350529740, 1350540540, 1350542220, 1350549660, 1350558600, 
1350562200, 1350568800, 1350576000, 1350578940, 1350579300, 1350581580, 
1350583560, 1350589740, 1350609600, 1350611220, 1350622380, 1350625080, 
1350634560, 1350644400, 1350648000, 1350654420, 1350656460, 1350658800, 
1350662460, 1350666480, 1350668580, 1350684000, 1350700200, 1350702180, 
1350710760, 1350713520, 1350722220, 1350725580, 1350728940, 1350733380, 
1350736020, 1350752400, 1350755100, 1350763200, 1350779880, 1350781140, 
1350790980, 1350792060, 1350804000, 1350805980, 1350808200, 1350813600, 
1350817800, 1350822600, 1350832020, 1350836520, 1350836700, 1350853200, 
1350864000, 1350865800, 1350876420, 1350879120, 1350885240, 1350886740, 
1350890760, 1350899580, 1350901800, 1350905700, 1350907200, 1350914400, 
1350916200, 1350918000, 1350921600, 1350925200, 1350932460, 1350934200, 
1350936900, 1350943200, 1350957600, 1350959220, 1350967920, 1350970380, 
1350976320, 1350991380, 1350991680, 1350994800, 1351011660, 1351023600, 
1351040760, 1351044660, 1351056360, 1351060440, 1351070580, 1351075380, 
1351077060, 1351086600, 1351089900, 1351098000, 1351101600, 1351110780, 
1351111680, 1351116600, 1351129140, 1351131180, 1351145460, 1351146480, 
1351146660, 1351158000, 1351162140, 1351162320, 1351166400, 1351169760, 
1351175040, 1351185300, 1351187100, 1351195200, 1351213200, 1351214880, 
1351219080, 1351220400, 1351229640, 1351232280, 1351236360, 1351246080, 
1351248720, 1351251300, 1351258500, 1351268940, 1351270500, 1351271160, 
1351273500, 1351276020, 1351281960, 1351287900, 1351300500, 1351303200, 
1351309860, 1351312800, 1351316940, 1351320300, 1351331040, 1351343700, 
1351345500, 1351356660, 1351358280, 1351364400, 1351366200, 1351368900, 
1351369800, 1351372920, 1351374720, 1351377000, 1351390260, 1351391820, 
1351400100, 1351401060, 1351411680, 1351416420, 1351418220, 1351429200, 
1351432800, 1351454400, 1351464480, 1351466400, 1351476660, 1351477440, 
1351487340, 1351488540, 1351495680, 1351505340, 1351516380, 1351524720, 
1351528260, 1351529160, 1351536720, 1351545240, 1351558620, 1351559340, 
1351568340, 1351572360, 1351581300, 1351584000, 1351587600, 1351591200, 
1351600200, 1351605600, 1351609200, 1351622820, 1351628220, 1351631820, 
1351654200, 1351655580, 1351667880, 1351675020, 1351677060, 1351681200, 
1351683600, 1351687140, 1351697580, 1351713780, 1351737060, 1351739100, 
1351753920, 1351757220, 1351759320, 1351764000, 1351767600, 1351778580, 
1351783800, 1351792980, 1351796580, 1351804800, 1351839600, 1351845840, 
1351847220, 1351850340, 1351852860, 1351857600, 1351859400, 1351865100, 
1351872840, 1351888200, 1351918800, 1351921500, 1351925400, 1351926000, 
1351929660, 1351937940, 1351940880, 1351944900, 1351952700, 1351965600, 
1351972920, 1351976400, 1352015700, 1352026740, 1352026860, 1352027400, 
1352036400, 1352042820, 1352045040, 1352050200, 1352051880, 1352056740, 
1352060580, 1352069280, 1352101260, 1352106900, 1352109360, 1352114040, 
1352118540, 1352124240, 1352125440, 1352132220, 1352141580, 1352155020, 
1352188080, 1352193060, 1352195160, 1352197260, 1352201220, 1352203860, 
1352212680, 1352221500, 1352222760, 1352239620, 1352273520, 1352277720, 
1352281740, 1352286780, 1352292060, 1352298600, 1352307600, 1352319960, 
1352359380, 1352364180, 1352366880, 1352370360, 1352379780, 1352385000, 
1352386800, 1352390520, 1352392980, 1352405400, 1352446920, 1352451600, 
1352453400, 1352458800, 1352463000, 1352468400, 1352470800, 1352475000, 
1352476800, 1352481540, 1352486580, 1352492580, 1352533320, 1352538000, 
1352541000, 1352547540, 1352549340, 1352556000, 1352563260, 1352570760, 
1352571060, 1352580540, 1352620860, 1352625600, 1352627880, 1352632020, 
1352634660, 1352640660, 1352642760, 1352648940, 1352650800, 1352665560, 
1352704440, 1352712600, 1352716200, 1352719800, 1352721600, 1352729640, 
1352732400, 1352737680, 1352742840, 1352748060, 1352748720, 1352756760, 
1352793300, 1352797200, 1352800800, 1352804940, 1352816580, 1352832240, 
1352834340, 1352842380, 1352876340, 1352882700, 1352884800, 1352890380, 
1352895360, 1352900880, 1352903040, 1352926800, 1352962800, 1352970000, 
1352973000, 1352975400, 1352984400, 1352990520, 1352992980, 1352998620, 
1352999820, 1353005100, 1353006900, 1353014400, 1353049800, 1353057540, 
1353065040, 1353070140, 1353077340, 1353096060, 1353136920, 1353145620, 
1353152040, 1353159600, 1353162240, 1353168000, 1353170700, 1353175080, 
1353176280, 1353186000, 1353225180, 1353231120, 1353231660, 1353235800, 
1353242400, 1353251760, 1353253080, 1353257760, 1353259140, 1353263340, 
1353265140, 1353272400, 1353308340, 1353314160, 1353316320, 1353320400, 
1353329100, 1353337920, 1353345300, 1353351600, 1353353400, 1353359100, 
1353395280, 1353401100, 1353402900, 1353407400, 1353416700, 1353423600, 
1353424680, 1353431880, 1353436260, 1353443820, 1353483900, 1353488400, 
1353491040, 1353495540, 1353499140, 1353504240, 1353511860, 1353517500, 
1353518940, 1353531540, 1353567720, 1353571800, 1353574560, 1353586800, 
1353590400, 1353597900, 1353604380, 1353609000, 1353611760, 1353618000, 
1353656640, 1353662700, 1353663180, 1353666600, 1353668400, 1353673200, 
1353674700, 1353681000, 1353681900, 1353685380, 1353691800, 1353700920, 
1353740520, 1353749400, 1353751200, 1353754800, 1353758400, 1353765420, 
1353768360, 1353773040, 1353776520, 1353790800, 1353826800, 1353838080, 
1353839880, 1353846600, 1353848400, 1353852960, 1353865020, 1353875520, 
1353912300, 1353928800, 1353940620, 1353947400, 1353949200, 1353954720, 
1353955920, 1353962700, 1354002300, 1354008120, 1354009980, 1354021140, 
1354027500, 1354033380, 1354038000, 1354047840, 1354088100, 1354093320, 
1354095300, 1354099980, 1354108260, 1354123860, 1354124460, 1354126560, 
1354126740, 1354127340, 1354132860, 1354136400, 1354174200, 1354179660, 
1354182660, 1354188300, 1354192500), class = c("POSIXct", "POSIXt"
), tzone = "GMT"), event = c(0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 
0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 
1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)), row.names = c(309L, 
618L, 308L, 617L, 307L, 616L, 306L, 615L, 305L, 614L, 304L, 613L, 
303L, 612L, 302L, 611L, 301L, 610L, 300L, 609L, 299L, 608L, 298L, 
607L, 297L, 606L, 296L, 605L, 295L, 604L, 294L, 603L, 293L, 602L, 
292L, 601L, 291L, 600L, 290L, 599L, 289L, 598L, 288L, 597L, 287L, 
596L, 286L, 595L, 285L, 594L, 284L, 593L, 283L, 592L, 282L, 591L, 
281L, 590L, 280L, 589L, 279L, 588L, 278L, 587L, 277L, 586L, 276L, 
585L, 275L, 584L, 274L, 583L, 273L, 582L, 272L, 581L, 271L, 580L, 
270L, 579L, 269L, 578L, 268L, 577L, 267L, 576L, 266L, 575L, 265L, 
574L, 264L, 573L, 263L, 572L, 262L, 571L, 261L, 570L, 260L, 569L, 
259L, 568L, 258L, 567L, 257L, 566L, 256L, 565L, 255L, 564L, 254L, 
563L, 253L, 562L, 252L, 561L, 251L, 560L, 250L, 559L, 249L, 558L, 
248L, 557L, 247L, 556L, 246L, 555L, 245L, 554L, 244L, 553L, 243L, 
552L, 242L, 551L, 241L, 550L, 240L, 549L, 239L, 548L, 238L, 547L, 
237L, 546L, 236L, 545L, 235L, 544L, 234L, 543L, 233L, 542L, 232L, 
541L, 231L, 540L, 230L, 539L, 229L, 538L, 228L, 537L, 227L, 536L, 
226L, 535L, 225L, 534L, 224L, 533L, 223L, 532L, 222L, 531L, 221L, 
530L, 220L, 529L, 219L, 528L, 218L, 527L, 217L, 526L, 216L, 525L, 
215L, 524L, 214L, 523L, 213L, 522L, 212L, 521L, 211L, 520L, 210L, 
519L, 209L, 518L, 208L, 517L, 207L, 516L, 206L, 515L, 205L, 514L, 
204L, 513L, 203L, 512L, 202L, 511L, 201L, 510L, 200L, 509L, 199L, 
508L, 198L, 507L, 197L, 506L, 196L, 505L, 195L, 504L, 194L, 503L, 
193L, 502L, 192L, 501L, 191L, 500L, 190L, 499L, 189L, 498L, 188L, 
497L, 187L, 496L, 186L, 495L, 185L, 494L, 184L, 493L, 183L, 492L, 
182L, 491L, 181L, 490L, 180L, 489L, 179L, 488L, 178L, 487L, 177L, 
486L, 176L, 485L, 175L, 484L, 174L, 483L, 173L, 482L, 172L, 481L, 
171L, 480L, 170L, 479L, 169L, 478L, 168L, 477L, 167L, 476L, 166L, 
475L, 165L, 474L, 164L, 473L, 163L, 472L, 162L, 471L, 161L, 470L, 
160L, 469L, 159L, 468L, 158L, 467L, 157L, 466L, 156L, 465L, 155L, 
464L, 154L, 463L, 153L, 462L, 152L, 461L, 151L, 460L, 150L, 459L, 
149L, 148L, 458L, 457L, 147L, 456L, 146L, 455L, 145L, 454L, 144L, 
453L, 143L, 452L, 142L, 451L, 141L, 450L, 140L, 449L, 139L, 448L, 
138L, 447L, 137L, 446L, 136L, 445L, 135L, 444L, 134L, 443L, 133L, 
442L, 132L, 441L, 131L, 440L, 130L, 439L, 129L, 438L, 128L, 437L, 
127L, 436L, 126L, 435L, 125L, 434L, 124L, 433L, 123L, 432L, 122L, 
431L, 121L, 430L, 120L, 429L, 119L, 428L, 118L, 427L, 117L, 426L, 
116L, 425L, 115L, 424L, 114L, 423L, 113L, 422L, 112L, 421L, 111L, 
420L, 110L, 419L, 109L, 418L, 108L, 417L, 107L, 416L, 106L, 415L, 
105L, 414L, 104L, 413L, 103L, 412L, 102L, 411L, 101L, 410L, 100L, 
409L, 99L, 408L, 98L, 407L, 97L, 406L, 96L, 405L, 95L, 404L, 
94L, 403L, 93L, 402L, 92L, 401L, 91L, 400L, 90L, 399L, 89L, 398L, 
88L, 397L, 87L, 396L, 86L, 395L, 85L, 394L, 84L, 393L, 83L, 392L, 
82L, 391L, 81L, 390L, 80L, 389L, 79L, 388L, 78L, 387L, 77L, 386L, 
76L, 385L, 75L, 384L, 74L, 383L, 73L, 382L, 72L, 381L, 71L, 380L, 
70L, 379L, 69L, 378L, 68L, 377L, 67L, 376L, 66L, 375L, 65L, 374L, 
64L, 373L, 63L, 372L, 62L, 371L, 61L, 370L, 60L, 369L, 59L, 368L, 
58L, 367L, 57L, 366L, 56L, 365L, 55L, 364L, 54L, 363L, 53L, 362L, 
52L, 361L, 51L, 360L, 50L, 359L, 49L, 358L, 48L, 357L, 47L, 356L, 
46L, 355L, 45L, 354L, 44L, 353L, 43L, 352L, 42L, 351L, 41L, 350L, 
40L, 349L, 39L, 348L, 38L, 347L, 37L, 346L, 36L, 345L, 35L, 344L, 
34L, 343L, 33L, 342L, 32L, 341L, 31L, 340L, 30L, 339L, 29L, 338L, 
28L, 337L, 27L, 336L, 26L, 335L, 25L, 334L, 24L, 333L, 23L, 332L, 
22L, 331L, 21L, 330L, 20L, 329L, 19L, 328L, 18L, 327L, 17L, 326L, 
16L, 325L, 15L, 324L, 14L, 323L, 13L, 322L, 12L, 321L, 11L, 320L, 
10L, 319L, 9L, 318L, 8L, 317L, 7L, 316L, 6L, 315L, 5L, 314L, 
4L, 313L, 3L, 312L, 2L, 311L, 1L, 310L), class = "data.frame")


# load/upload the data
dfupload <- reactive({
    
                if (is.null(input$file1))
                        return(dfsample)                
                data<-read.csv(input$file1$datapath,header = TRUE,
                colClasses = c("POSIXct","numeric"))
                data
        })

# set data filter values
dffilter <- eventReactive(input$dateRange, {
    
                if (is.null(input$dateRange)) 
                        return(as.POSIXct(c("1900-01-01","2100-01-01")))                
                data <- input$dateRange
                data
        })

# collect date range
output$interaction_dateRange <- renderUI({
    
    dfnap2 <- dfupload()
    
    dateRangeInput('dateRange',
                   label = 'Select the date range you with to view',
                   start = min(dfnap2$napt),end = max(dfnap2$napt),
                   min = min(dfnap2$napt),max = (max(dfnap2$napt)+24*60*60))
    
})

# prepare the data/render the plot

output$distPlot <- renderPlot({

    dfnap <- dfupload()    
    
    dfnap  <- subset(dfnap, dfnap$napt >= dffilter()[1] & dfnap$napt <= dffilter()[2]) 
   
    # rounding the time
    
    dfnap$rndnapt <- round_date(dfnap$napt,"15 minutes")
    
    # add missing time segments
    
    dfseg <- data.frame(rndnapt = seq(min(dfnap$rndnapt),max(dfnap$rndnapt), by = '15 mins'))
    dfnapfull <- merge(dfnap,dfseg,by = 'rndnapt',all.y = T)
    
    dfnapfill <- tidyr::fill(dfnapfull,event)
    
    # summarize multiple events in a segment (fusy baby periods)
    
    dfnapfill <- dfnapfill %>% group_by(rndnapt) %>% summarise(event = mean(event))
    dfnapfill$width <- 0
    dfnapfill$hour <- (as.numeric(dfnapfill$rndnapt) %% (24*60*60) / 3600)
    
    # use an algorythm to "predict" the next day
    
    napmod <- lm(event ~ as.factor(hour),data = dfnapfill)
    
    dfnextday <- data.frame(rndnapt = seq(max(dfnapfill$rndnapt) + 15*60,max(dfnapfill$rndnapt) + (24*60*60) + (15*16)
                                          , by = '15 mins'))
    dfnextday$hour <- (as.numeric(dfnextday$rndnapt) %% (24*60*60) / 3600)
    dfnextday$event <- predict(napmod,dfnextday)
    dfnextday$width <- 2
    
    dfnapfill <- rbind(dfnapfill,dfnextday[,c("rndnapt","event","width","hour")])
    
    # make the plot
    
    days <- as.numeric(difftime(max(dfnapfill$rndnapt),min(dfnapfill$rndnapt), units = c("days")))
    
    ggplot(dfnapfill,
               aes(x=(as.numeric(rndnapt) %% (24*60*60) / 3600),
                   xend=(as.numeric(rndnapt) %% (24*60*60) / 3600) + 0.25,
                   y=rndnapt, yend=rndnapt + 15*60, colour=event)) +
            geom_segment(size=(30/days)+dfnapfill$width) +
            scale_x_continuous(limits=c(0,24), breaks=0:23, minor_breaks=0:24,
                               labels=paste0(rep(c(12,1:11),2), rep(c("AM","PM"),each=12))) +
            scale_y_datetime(limits=range(dfnapfill$rndnapt) + c(-3*24*3600,1*24*3600), 
                             labels = NULL) +
            labs(x=NULL,y=NULL,color="1 = awake\n0 = sleeping") +
            coord_polar() +
            theme_bw(base_size=10) + 
            theme(panel.border = element_blank(),axis.ticks = element_blank()) +
            scale_colour_gradient2(low="navy blue", mid="red", high="green", midpoint=.5) 

    })

})
